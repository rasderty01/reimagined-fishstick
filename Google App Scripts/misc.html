<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.17/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <title>MGiUK Add-ons</title>
  </head>

  <body
    class="bg-gray-100 bg-cover bg-fixed"
    style="
      background-image: url(https://images.pexels.com/photos/207228/pexels-photo-207228.jpeg);
    "
  >
    <div class="container mx-auto flex justify-center transition-all">
      <form
        id="form1"
        class="container-lg px-4 py-4 flex flex-col m-10 bg-white bg-opacity-80 transform translate-x-0 translate-y-0"
      >
        <div class="flex flex-col">
          <h1 class="text-center text-2xl font-black font-sans mb-2">
            Select Optional Services
          </h1>
        </div>

        <div class="flex-col p-3 items-center">
          <label class="flex w-full font-bold" for="email">Email Address</label>
          <input
            class="rounded-lg text-sm shadow-md focus:shadow-none placeholder-gray-500 w-full border border-solid border-blue-400 mt-4 px-3 py-2 bg-white focus:border-blue-800 focus:ring-4 focus:ring-sky-500 focus: outline-none focus: border-0 hover:bg-gray-50"
            type="email"
            id="email"
            name="email"
            placeholder="Enter your registered email address"
            required
            pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
          />
        </div>

        <div class="flex-col p-3">
          <label class="flex w-full font-bold">Other Services</label>
          <select
            id="raf"
            name="raf"
            class="text-center rounded-lg text-sm shadow-md focus:shadow-none placeholder-gray-500 w-full border border-solid border-blue-400 mt-4 py-2 bg-white focus:border-blue-800 focus:ring-4 focus:ring-sky-500 focus: outline-none focus: border-0 hover:bg-gray-50"
            required
          >
            <option value="">Select an Option</option>
            <option value="Rent-a-flight (Return)">
              Rent-a-flight (Return)
            </option>
            <option value="Rent-a-flight (One way)">
              Rent-a-flight (One way)
            </option>
            <option value="Rent-a-flight with hotel accommodation">
              Rent-a-flight with hotel accommodation
            </option>
          </select>
        </div>

        <div class="flex-col p-3 ml-2">
          <input
            type="checkbox"
            name="har"
            id="har"
            value="Hotel Accommodation Reservation"
          />
          <label class="font-normal" for="har"
            >Hotel Accommodation Reservation</label
          >
        </div>

        <div class="flex-col p-3 ml-2">
          <input
            type="checkbox"
            name="pas"
            id="pas"
            value="Philippine Accommodation (Studio)"
          />
          <label class="font-normal" for="pas"
            >Philippine Accommodation (Studio)</label
          >
        </div>

        <div class="flex-col p-3 ml-2">
          <input
            type="checkbox"
            name="mpa"
            id="mpa"
            value="Manila Personal Assistant"
          />
          <label class="font-normal" for="mpa">Manila Personal Assistant</label>
        </div>
        <div id="range" class="flex-col hidden">
          <div class="flex-col p-3 ml-2">
            <label class="font-normal" for="mpa"
              >Number of Days: <output id="values"></output
            ></label>
          </div>
          <div class="flex-col p-3 ml-2">
            <input type="range" name="days" id="days" min="1" max="10" />
          </div>
        </div>

        <div class="flex-col p-3 text-center">
          <button
            id="submitBtn"
            class="rounded border-solid shadow-xl hover:shadow-none bg-blue-800 hover:bg-blue-400 p-2 text-gray-50 active:bg-blue-800"
            type="submit"
          >
            Submit
          </button>
          <div id="loading" class="spinner hidden">
            <div class="relative inline-block">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink"
                style="
                  margin: auto;
                  background: none;
                  display: block;
                  shape-rendering: auto;
                "
                width="58px"
                height="58px"
                viewBox="0 0 100 100"
                preserveAspectRatio="xMidYMid"
              >
                <circle
                  cx="50"
                  cy="50"
                  r="0"
                  fill="none"
                  stroke="#0c7ae9"
                  stroke-width="3"
                >
                  <animate
                    attributeName="r"
                    repeatCount="indefinite"
                    dur="1s"
                    values="0;33"
                    keyTimes="0;1"
                    keySplines="0 0.2 0.8 1"
                    calcMode="spline"
                    begin="0s"
                  />
                  <animate
                    attributeName="opacity"
                    repeatCount="indefinite"
                    dur="1s"
                    values="1;0"
                    keyTimes="0;1"
                    keySplines="0.2 0 0.8 1"
                    calcMode="spline"
                    begin="0s"
                  />
                </circle>
                <circle
                  cx="50"
                  cy="50"
                  r="0"
                  fill="none"
                  stroke="#46dff0"
                  stroke-width="3"
                >
                  <animate
                    attributeName="r"
                    repeatCount="indefinite"
                    dur="1s"
                    values="0;33"
                    keyTimes="0;1"
                    keySplines="0 0.2 0.8 1"
                    calcMode="spline"
                    begin="-0.5s"
                  />
                  <animate
                    attributeName="opacity"
                    repeatCount="indefinite"
                    dur="1s"
                    values="1;0"
                    keyTimes="0;1"
                    keySplines="0.2 0 0.8 1"
                    calcMode="spline"
                    begin="-0.5s"
                  />
                </circle>
                <!-- [ldio] generated by https://loading.io/ -->
              </svg>
            </div>
          </div>
        </div>
      </form>

      <form
        id="upload-form"
        enctype="multipart/form-data"
        class="container-lg px-4 py-4 flex flex-col m-10 bg-white bg-opacity-80 transform translate-x-0 translate-y-0 hidden"
      >
        <div class="flex flex-col">
          <h1 class="text-center text-2xl font-black font-sans mb-2">
            Follow the steps below:
          </h1>
        </div>
        <div class="flex-col text-xl font-bold p-2 mb-4 w-80">
          Step 1: Tap/click the button to download the invoice:
        </div>
        <div
          id="download-link-container"
          class="flex-col justify-center text-center py-5"
        ></div>
        <label class="mb-2 block text-xl font-bold text-black p-2 mb-4 w-80"
          >Step 2: After paying, upload your proof of purchase:
        </label>
        <input
          type="file"
          id="uploadedFile"
          name="uploadedFile"
          required
          class="my-5 cursor-pointer"
        />
        <div class="flex-col p-3 text-center">
          <button
            id="submit"
            value="submit"
            class="rounded border-solid shadow-xl hover:shadow-none bg-blue-800 hover:bg-blue-400 p-2 text-gray-50 active:bg-blue-800"
          >
            Submit
          </button>
          <div id="spinner1" class="spinner hidden">
            <div class="relative inline-block">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink"
                style="
                  margin: auto;
                  background: none;
                  display: block;
                  shape-rendering: auto;
                "
                width="58px"
                height="58px"
                viewBox="0 0 100 100"
                preserveAspectRatio="xMidYMid"
              >
                <circle
                  cx="50"
                  cy="50"
                  r="0"
                  fill="none"
                  stroke="#0c7ae9"
                  stroke-width="3"
                >
                  <animate
                    attributeName="r"
                    repeatCount="indefinite"
                    dur="1s"
                    values="0;33"
                    keyTimes="0;1"
                    keySplines="0 0.2 0.8 1"
                    calcMode="spline"
                    begin="0s"
                  />
                  <animate
                    attributeName="opacity"
                    repeatCount="indefinite"
                    dur="1s"
                    values="1;0"
                    keyTimes="0;1"
                    keySplines="0.2 0 0.8 1"
                    calcMode="spline"
                    begin="0s"
                  />
                </circle>
                <circle
                  cx="50"
                  cy="50"
                  r="0"
                  fill="none"
                  stroke="#46dff0"
                  stroke-width="3"
                >
                  <animate
                    attributeName="r"
                    repeatCount="indefinite"
                    dur="1s"
                    values="0;33"
                    keyTimes="0;1"
                    keySplines="0 0.2 0.8 1"
                    calcMode="spline"
                    begin="-0.5s"
                  />
                  <animate
                    attributeName="opacity"
                    repeatCount="indefinite"
                    dur="1s"
                    values="1;0"
                    keyTimes="0;1"
                    keySplines="0.2 0 0.8 1"
                    calcMode="spline"
                    begin="-0.5s"
                  />
                </circle>
                <!-- [ldio] generated by https://loading.io/ -->
              </svg>
            </div>
          </div>
        </div>
      </form>
    </div>

    <script>
      const randomInvoiceNumber =
        "MISC-" + Math.floor(Math.random() * 9000 + 1000);

      const data1 = {
        // Your existing form data
        randomInvoiceNumber: randomInvoiceNumber,
      };

      console.log(data1);
      console.log(randomInvoiceNumber);
      console.log(randomInvoiceNumber);
      console.log(randomInvoiceNumber);

      const value = document.querySelector("#values");
      const input = document.querySelector("#days");
      value.textContent = input.value;
      input.addEventListener("input", (event) => {
        value.textContent = event.target.value;
      });

      document.getElementById("mpa").addEventListener("change", showdays);

      function showdays() {
        var mpa = document.getElementById("mpa");
        var rangediv = document.getElementById("range");

        if (mpa.checked) {
          rangediv.classList.remove("hidden");
        } else {
          rangediv.classList.add("hidden");
        }
      }

      function preventFormSubmit() {
        var forms = document.querySelectorAll("form");
        for (var i = 0; i < forms.length; i++) {
          forms[i].addEventListener("submit", function (event) {
            event.preventDefault();
          });
        }
      }
      window.addEventListener("load", preventFormSubmit);

      document
        .getElementById("submitBtn")
        .addEventListener("click", function () {
          event.preventDefault();
          var form3 = document.getElementById("form1");
          if (!form3.checkValidity()) {
            form3.reportValidity();
            return;
          }

          var email = document.getElementById("email").value;
          var rentaflight = document.getElementById("raf").value;
          var har = document.querySelector("#har");

          if (har.checked) {
            var har = document.querySelector("#har").value;
          } else {
            har = "";
          }

          console.log(har);

          var pas = document.querySelector("#pas");

          if (pas.checked) {
            var pas = document.querySelector("#pas").value;
          } else {
            pas = "";
          }

          console.log(pas);

          var manilapa = document.querySelector("#mpa");

          if (manilapa.checked) {
            var manilapa = document.querySelector("#mpa").value;
          } else {
            manilapa = "";
          }

          console.log(manilapa);

          if (manilapa === "Manila Personal Assistant") {
            var manilapadays = document.getElementById("days").value;
          } else {
            manilapadays = "";
          }

          console.log(manilapadays);

          var spinner = document.getElementById("loading");
          var upload = document.getElementById("upload-form");

          console.log(randomInvoiceNumber);

          if (email) {
            // Show the spinner
            spinner.classList.remove("hidden");

            google.script.run
              .withSuccessHandler(function (responseText) {
                // Hide the spinner
                spinner.classList.add("hidden");

                if (responseText === "EmailNotFound") {
                  alert(
                    "Email not found. Please try again with a valid email."
                  );
                  document.getElementById("form1").reset();
                } else {
                  upload.classList.remove("hidden");
                  var downloadUrl = responseText;
                  var downloadLinkContainer = document.getElementById(
                    "download-link-container"
                  );

                  // Create the download link element
                  var downloadLink = document.createElement("a");
                  downloadLink.href = downloadUrl;
                  downloadLink.textContent = "Download Invoice";
                  downloadLink.target = "_blank";
                  downloadLink.classList.add(
                    "w-fit",
                    "rounded",
                    "bg-blue-800",
                    "shadow-xl",
                    "text-gray-50",
                    "p-2",
                    "font-bold",
                    "text-white",
                    "hover:bg-blue-400",
                    "active:bg-blue-800"
                  );

                  // Clear the container and insert the download link
                  downloadLinkContainer.innerHTML = "";
                  downloadLinkContainer.appendChild(downloadLink);
                }
              })
              .withFailureHandler(function (error) {
                alert("This is the Error: " + error);
              })
              .verifyEmail(
                email,
                rentaflight,
                har,
                pas,
                manilapa,
                manilapadays,
                data1.randomInvoiceNumber
              );
          }
        });

      document
        .getElementById("upload-form")
        .addEventListener("submit", handleFormSubmit);

      function handleFormSubmit(event) {
        event.preventDefault();
        var form = document.getElementById("upload-form");

        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }
        var spinner1 = document.getElementById("spinner1");
        spinner1.classList.remove("hidden");
        console.log(randomInvoiceNumber);

        var uploadedFile = document.getElementById("uploadedFile").files[0];
        var reader = new FileReader();
        reader.onloadend = function (e) {
          var fileData = {
            data: e.target.result,
            name: uploadedFile.name,
            randomInvoiceNumber: randomInvoiceNumber,
            email: document.getElementById("email").value,
          };

          google.script.run
            .withSuccessHandler(success)
            .withFailureHandler(function (error) {
              spinner1.classList.add("hidden");
              alert("Error: " + error);
            })
            .processForm(fileData);
        };
        reader.readAsDataURL(uploadedFile);
      }

      function success() {
        document.getElementById("upload-form").reset();

        let countdown = 5;

        const countdownInterval = setInterval(() => {
          countdown--;
          if (countdown >= 0) {
            Swal.update({
              icon: "success",
              title: "Proof-of-Payment Sent!",
              text: `Redirecting in ${countdown}...`,
            });
          } else {
            clearInterval(countdownInterval);
            window.location.href = "https://www.example.com"; // Replace with your desired URL
          }
        }, 1000);

        Swal.fire({
          icon: "success",
          title: "Proof-of-Payment Sent!",
          text: `Redirecting in ${countdown}...`,
          showConfirmButton: false,
          allowOutsideClick: false,
          allowEscapeKey: false,
        });
      }
    </script>
  </body>
</html>
