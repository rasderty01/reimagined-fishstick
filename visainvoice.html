<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.17/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <title>MGiUK Visa Services</title>
  </head>

  <body
    class="bg-gray-100 bg-cover bg-fixed"
    style="
      background-image: url(https://images.pexels.com/photos/207228/pexels-photo-207228.jpeg);
    "
  >
    <div class="container mx-auto flex justify-center transition-all">
      <form
        id="form1"
        class="container-lg px-4 py-4 flex flex-col m-10 bg-white bg-opacity-80 transform translate-x-0 translate-y-0"
      >
        <div class="flex flex-col">
          <h1 class="text-center text-2xl font-black font-sans mb-2">
            Choose your Visa Package
          </h1>
        </div>

        <div class="flex-col p-3 items-center">
          <label class="flex w-full font-bold" for="email">Email Address</label>
          <input
            class="rounded-lg text-sm shadow-md focus:shadow-none placeholder-gray-500 w-full border border-solid border-blue-400 mt-4 px-3 py-2 bg-white focus:border-blue-800 focus:ring-4 focus:ring-sky-500 focus: outline-none focus: border-0 hover:bg-gray-50"
            type="email"
            id="email"
            name="email"
            placeholder="Enter your registered email address"
            required
            pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
          />
        </div>

        <div class="flex-col p-3">
          <label class="flex w-full font-bold">Visa Services</label>
          <select
            id="mySelectVS"
            name="visaservice"
            class="text-center rounded-lg text-sm shadow-md focus:shadow-none placeholder-gray-500 w-full border border-solid border-blue-400 mt-4 py-2 bg-white focus:border-blue-800 focus:ring-4 focus:ring-sky-500 focus: outline-none focus: border-0 hover:bg-gray-50"
            required
          >
            <option value="">Select an Option</option>
            <option value="Visit Visa">Visit Visa</option>
            <option value="Fiancé Visa">Fiance Visa</option>
            <option value="Spouse Visa (FLR-M) Inside UK">
              Spouse Visa (FLR-M) Inside UK
            </option>
            <option value="Spouse Visa (FLR-M) Outside UK Processing">
              Spouse Visa (FLR-M) Outside UK
            </option>
            <option value="Married Visit Visa">Married Visit Visa</option>
            <option value="Unmarried Partner Visa">
              Unmarried Partner Visa
            </option>
            <option value="PBS/Skilled Worker Spouse Visa">
              PBS/Skilled Worker Spouse Visa
            </option>
            <option value="PBS/Skilled Worker Unmarried Partner Visa">
              PBS/Skilled Worker Unmarried Partner Visa
            </option>
            <option value="PBS/Skilled Worker Same-sex Partner Visa">
              PBS/Skilled Worker Same-sex Partner Visa
            </option>
            <option value="PBS/ Skilled Worker Child Dependant Visa">
              PBS/ Skilled Worker Child Dependant Visa
            </option>
            <option value="Indefinite Leave to Remain (ILR)">
              Indefinite Leave to Remain (ILR)
            </option>
            <option value="British Citizenship Processing">
              British Citizenship Processing
            </option>
            <option value="Child Dependant Visa">Child Dependant Visa</option>
          </select>
        </div>

        <div
          class="flex flex-wrap w-80 rounded-md border-black bg-yellow-100 font-normal font-sans text-xs m-auto p-2 overflow-auto"
        >
          <b>Note:</b> Please select the appropriate option based on what was
          discussed and agreed upon during the consultation call.
        </div>
        <div class="flex-col p-3">
          <label class="flex w-full font-bold">Priority</label>
          <select
            id="mySelectP"
            name="priority"
            class="text-center rounded-lg text-sm shadow-md focus:shadow-none placeholder-gray-500 w-full border border-solid border-blue-400 mt-4 py-2 bg-white focus:border-blue-800 focus:ring-4 focus:ring-sky-500 focus: outline-none focus: border-0 hover:bg-gray-50"
            required
          >
            <option disabled selected>Select an Option</option>
            <option value="Priority Service (7 working days; £100)">
              Priority Service (7 working days)
            </option>
            <option value="Priority Service (After Final Declaration)">
              Priority Service (After Final Declaration)
            </option>
            <option value="">No Priority</option>
          </select>
        </div>

        <div class="flex-col p-3 text-center">
          <button
            id="submitBtn"
            class="rounded border-solid shadow-xl hover:shadow-none bg-blue-800 hover:bg-blue-400 p-2 text-gray-50 active:bg-blue-800"
            type="submit"
          >
            Submit
          </button>
          <div id="loading" class="spinner hidden">
            <div class="relative inline-block">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink"
                style="
                  margin: auto;
                  background: none;
                  display: block;
                  shape-rendering: auto;
                "
                width="58px"
                height="58px"
                viewBox="0 0 100 100"
                preserveAspectRatio="xMidYMid"
              >
                <circle
                  cx="50"
                  cy="50"
                  r="0"
                  fill="none"
                  stroke="#0c7ae9"
                  stroke-width="3"
                >
                  <animate
                    attributeName="r"
                    repeatCount="indefinite"
                    dur="1s"
                    values="0;33"
                    keyTimes="0;1"
                    keySplines="0 0.2 0.8 1"
                    calcMode="spline"
                    begin="0s"
                  />
                  <animate
                    attributeName="opacity"
                    repeatCount="indefinite"
                    dur="1s"
                    values="1;0"
                    keyTimes="0;1"
                    keySplines="0.2 0 0.8 1"
                    calcMode="spline"
                    begin="0s"
                  />
                </circle>
                <circle
                  cx="50"
                  cy="50"
                  r="0"
                  fill="none"
                  stroke="#46dff0"
                  stroke-width="3"
                >
                  <animate
                    attributeName="r"
                    repeatCount="indefinite"
                    dur="1s"
                    values="0;33"
                    keyTimes="0;1"
                    keySplines="0 0.2 0.8 1"
                    calcMode="spline"
                    begin="-0.5s"
                  />
                  <animate
                    attributeName="opacity"
                    repeatCount="indefinite"
                    dur="1s"
                    values="1;0"
                    keyTimes="0;1"
                    keySplines="0.2 0 0.8 1"
                    calcMode="spline"
                    begin="-0.5s"
                  />
                </circle>
                <!-- [ldio] generated by https://loading.io/ -->
              </svg>
            </div>
          </div>
        </div>
      </form>

      <form
        id="upload-form"
        enctype="multipart/form-data"
        class="container-lg px-4 py-4 flex flex-col m-10 bg-white bg-opacity-80 transform translate-x-0 translate-y-0 hidden"
      >
        <div class="flex flex-col">
          <h1 class="text-center text-2xl font-black font-sans mb-2">
            Follow the steps below:
          </h1>
        </div>
        <div class="flex-col text-xl font-bold p-2 mb-4 w-80">
          Step 1: Tap/click the button to download the invoice:
        </div>
        <div
          id="download-link-container"
          class="flex-col justify-center text-center py-5"
        ></div>
        <label class="mb-2 block text-xl font-bold text-black p-2 mb-4 w-80"
          >Step 2: After paying, upload your proof of purchase:
        </label>
        <input
          type="file"
          id="uploadedFile"
          name="uploadedFile"
          required
          class="my-5 cursor-pointer"
        />
        <div class="flex-col p-3 text-center">
          <button
            id="submit"
            value="submit"
            class="rounded border-solid shadow-xl hover:shadow-none bg-blue-800 hover:bg-blue-400 p-2 text-gray-50 active:bg-blue-800"
          >
            Submit
          </button>
          <div id="spinner1" class="spinner hidden">
            <div class="relative inline-block">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink"
                style="
                  margin: auto;
                  background: none;
                  display: block;
                  shape-rendering: auto;
                "
                width="58px"
                height="58px"
                viewBox="0 0 100 100"
                preserveAspectRatio="xMidYMid"
              >
                <circle
                  cx="50"
                  cy="50"
                  r="0"
                  fill="none"
                  stroke="#0c7ae9"
                  stroke-width="3"
                >
                  <animate
                    attributeName="r"
                    repeatCount="indefinite"
                    dur="1s"
                    values="0;33"
                    keyTimes="0;1"
                    keySplines="0 0.2 0.8 1"
                    calcMode="spline"
                    begin="0s"
                  />
                  <animate
                    attributeName="opacity"
                    repeatCount="indefinite"
                    dur="1s"
                    values="1;0"
                    keyTimes="0;1"
                    keySplines="0.2 0 0.8 1"
                    calcMode="spline"
                    begin="0s"
                  />
                </circle>
                <circle
                  cx="50"
                  cy="50"
                  r="0"
                  fill="none"
                  stroke="#46dff0"
                  stroke-width="3"
                >
                  <animate
                    attributeName="r"
                    repeatCount="indefinite"
                    dur="1s"
                    values="0;33"
                    keyTimes="0;1"
                    keySplines="0 0.2 0.8 1"
                    calcMode="spline"
                    begin="-0.5s"
                  />
                  <animate
                    attributeName="opacity"
                    repeatCount="indefinite"
                    dur="1s"
                    values="1;0"
                    keyTimes="0;1"
                    keySplines="0.2 0 0.8 1"
                    calcMode="spline"
                    begin="-0.5s"
                  />
                </circle>
                <!-- [ldio] generated by https://loading.io/ -->
              </svg>
            </div>
          </div>
        </div>
      </form>
    </div>

    <script>
      const randomInvoiceNumber =
        "MISC-" + Math.floor(Math.random() * 9000 + 1000);

      const data1 = {
        // Your existing form data
        randomInvoiceNumber: randomInvoiceNumber,
      };

      console.log(data1);
      console.log(randomInvoiceNumber);
      console.log(randomInvoiceNumber);
      console.log(randomInvoiceNumber);

      function preventFormSubmit() {
        var forms = document.querySelectorAll("form");
        for (var i = 0; i < forms.length; i++) {
          forms[i].addEventListener("submit", function (event) {
            event.preventDefault();
          });
        }
      }
      window.addEventListener("load", preventFormSubmit);

      document
        .getElementById("submitBtn")
        .addEventListener("click", function () {
          event.preventDefault();
          var form3 = document.getElementById("form1");
          if (!form3.checkValidity()) {
            form3.reportValidity();
            return;
          }

          var email = document.getElementById("email").value;
          var visaservice = document.getElementById("mySelectVS").value;
          var priority = document.getElementById("mySelectP").value;
          var spinner = document.getElementById("loading");
          var upload = document.getElementById("upload-form");

          if (email) {
            // Show the spinner
            spinner.classList.remove("hidden");

            google.script.run
              .withSuccessHandler(function (responseText) {
                // Hide the spinner
                spinner.classList.add("hidden");

                if (responseText === "EmailNotFound") {
                  alert(
                    "Email not found. Please try again with a valid email."
                  );
                  document.getElementById("form1").reset();
                } else {
                  upload.classList.remove("hidden");
                  var downloadUrl = responseText;
                  var downloadLinkContainer = document.getElementById(
                    "download-link-container"
                  );

                  // Create the download link element
                  var downloadLink = document.createElement("a");
                  downloadLink.href = downloadUrl;
                  downloadLink.textContent = "Download Invoice";
                  downloadLink.target = "_blank";
                  downloadLink.classList.add(
                    "w-fit",
                    "rounded",
                    "bg-blue-800",
                    "shadow-xl",
                    "text-gray-50",
                    "p-2",
                    "font-bold",
                    "text-white",
                    "hover:bg-blue-400",
                    "active:bg-blue-800"
                  );

                  // Clear the container and insert the download link
                  downloadLinkContainer.innerHTML = "";
                  downloadLinkContainer.appendChild(downloadLink);
                }
              })
              .withFailureHandler(function (error) {
                alert("This is the Error: " + error);
              })
              .verifyEmail(
                email,
                visaservice,
                priority,
                data1.randomInvoiceNumber
              );
          }
        });

      document
        .getElementById("upload-form")
        .addEventListener("submit", handleFormSubmit);

      function handleFormSubmit(event) {
        event.preventDefault();
        var form = document.getElementById("upload-form");

        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }
        var spinner1 = document.getElementById("spinner1");
        spinner1.classList.remove("hidden");

        var uploadedFile = document.getElementById("uploadedFile").files[0];
        var reader = new FileReader();
        reader.onloadend = function (e) {
          var fileData = {
            data: e.target.result,
            name: uploadedFile.name,
            randomInvoiceNumber: randomInvoiceNumber,
            email: document.getElementById("email").value,
          };

          google.script.run
            .withSuccessHandler(success)
            .withFailureHandler(function (error) {
              spinner1.classList.add("hidden");
              alert("Error: " + error);
            })
            .processForm(fileData);
        };
        reader.readAsDataURL(uploadedFile);
      }

      function success() {
        var spinner1 = document.getElementById("spinner1");
        spinner1.classList.add("hidden");

        document.getElementById("upload-form").reset();

        // Ask the user if they want to purchase misc items
        Swal.fire({
          icon: "question",
          title: "Would you like to purchase optional items?",
          text: "Click 'Yes' to be redirected to the misc items page.",
          showCancelButton: true,
          confirmButtonText: "Yes",
          cancelButtonText: "No, thanks!",
        }).then((result) => {
          if (result.isConfirmed) {
            // User wants to purchase misc items, redirect to the misc items page
            window.open(
              "https://script.google.com/macros/s/AKfycbw0e0ZSn9jbg5LhW7tYLKDZ3VHYKIFcbcjv-CHbG62MvIVxz5Nv6NxeND1SgfsJF5S9/exec",
              "_blank"
            ); // Replace with the URL of your misc items page
          } else {
            // User does not want to purchase misc items, redirect to the success page
            redirectToSuccessPage();
          }
        });
      }

      function redirectToSuccessPage() {
        let countdown = 5;

        const countdownInterval = setInterval(() => {
          countdown--;
          if (countdown >= 0) {
            Swal.update({
              icon: "success",
              title: "Proof-of-Payment Sent!",
              text: `Redirecting in ${countdown}...`,
            });
          } else {
            clearInterval(countdownInterval);
            window.open("https://mgiukgroup.com", "_blank"); // Replace with your desired URL
          }
        }, 1000);

        Swal.fire({
          icon: "success",
          title: "Proof-of-Payment Sent!",
          text: `Redirecting in ${countdown}...`,
          showConfirmButton: false,
          allowOutsideClick: false,
          allowEscapeKey: false,
        });
      }
    </script>
  </body>
</html>
